<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/BACKEND_DELETE_BARANG_FIX.js">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/BACKEND_DELETE_BARANG_FIX.js" />
              <option name="updatedContent" value="/**&#10; * ============================================&#10; * PERBAIKAN BACKEND: DELETE BARANG&#10; * ============================================&#10; * &#10; * MASALAH: Barang tidak bisa dihapus karena Foreign Key Constraint&#10; *          dari tabel order_detail yang referensi ke barang_id&#10; * &#10; * SOLUSI: Cek dulu apakah barang dipakai di order,&#10; *         jika iya, beri pesan error yang jelas&#10; * &#10; * ============================================&#10; * COPY CODE INI KE FILE BACKEND ANDA&#10; * ============================================&#10; */&#10;&#10;// ============================================&#10;// OPSI 1: CHECK DULU SEBELUM DELETE (RECOMMENDED)&#10;// ============================================&#10;&#10;app.delete('/api/barang/:id', async (req, res) =&gt; {&#10;    const { id } = req.params;&#10;&#10;    // Validasi ID&#10;    if (!id || isNaN(id)) {&#10;        return res.status(400).json({ &#10;            success: false,&#10;            message: 'ID barang tidak valid' &#10;        });&#10;    }&#10;&#10;    try {&#10;        // STEP 1: Cek apakah barang digunakan di order_detail&#10;        const [orderCheck] = await db.query(&#10;            'SELECT COUNT(*) as count FROM order_detail WHERE barang_id = ?',&#10;            [id]&#10;        );&#10;&#10;        if (orderCheck[0].count &gt; 0) {&#10;            // Barang masih dipakai di order - TIDAK BISA DIHAPUS&#10;            return res.status(409).json({&#10;                success: false,&#10;                message: `Barang tidak bisa dihapus karena sudah digunakan dalam ${orderCheck[0].count} order. Hapus order terkait terlebih dahulu.`&#10;            });&#10;        }&#10;&#10;        // STEP 2: Cek apakah barang ada&#10;        const [barangCheck] = await db.query(&#10;            'SELECT * FROM barang WHERE barang_id = ?',&#10;            [id]&#10;        );&#10;&#10;        if (barangCheck.length === 0) {&#10;            return res.status(404).json({&#10;                success: false,&#10;                message: 'Barang tidak ditemukan'&#10;            });&#10;        }&#10;&#10;        // STEP 3: Hapus gambar jika ada (optional)&#10;        if (barangCheck[0].gambar_url) {&#10;            const fs = require('fs');&#10;            const path = require('path');&#10;            const imagePath = path.join(__dirname, 'public', barangCheck[0].gambar_url);&#10;            &#10;            if (fs.existsSync(imagePath)) {&#10;                fs.unlinkSync(imagePath);&#10;                console.log('Gambar berhasil dihapus:', imagePath);&#10;            }&#10;        }&#10;&#10;        // STEP 4: Hapus barang&#10;        const [result] = await db.query(&#10;            'DELETE FROM barang WHERE barang_id = ?',&#10;            [id]&#10;        );&#10;&#10;        if (result.affectedRows === 0) {&#10;            return res.status(404).json({&#10;                success: false,&#10;                message: 'Barang tidak ditemukan atau sudah dihapus'&#10;            });&#10;        }&#10;&#10;        // SUCCESS&#10;        console.log(`Barang dengan ID ${id} berhasil dihapus`);&#10;        res.status(200).json({&#10;            success: true,&#10;            message: 'Barang berhasil dihapus'&#10;        });&#10;&#10;    } catch (error) {&#10;        console.error('Error deleting barang:', error);&#10;        res.status(500).json({&#10;            success: false,&#10;            message: 'Gagal menghapus barang: ' + error.message&#10;        });&#10;    }&#10;});&#10;&#10;&#10;// ============================================&#10;// OPSI 2: SOFT DELETE (Tandai sebagai dihapus)&#10;// ============================================&#10;// Jika Anda ingin tetap menyimpan data barang tapi tidak ditampilkan&#10;&#10;/*&#10;STEP 1: Tambah kolom is_deleted di tabel barang:&#10;&#10;ALTER TABLE barang ADD COLUMN is_deleted TINYINT(1) DEFAULT 0;&#10;&#10;STEP 2: Ganti DELETE menjadi UPDATE:&#10;*/&#10;&#10;app.delete('/api/barang/:id', async (req, res) =&gt; {&#10;    const { id } = req.params;&#10;&#10;    try {&#10;        // Soft delete - tandai sebagai dihapus&#10;        const [result] = await db.query(&#10;            'UPDATE barang SET is_deleted = 1 WHERE barang_id = ?',&#10;            [id]&#10;        );&#10;&#10;        if (result.affectedRows === 0) {&#10;            return res.status(404).json({&#10;                success: false,&#10;                message: 'Barang tidak ditemukan'&#10;            });&#10;        }&#10;&#10;        res.status(200).json({&#10;            success: true,&#10;            message: 'Barang berhasil dihapus'&#10;        });&#10;&#10;    } catch (error) {&#10;        console.error('Error soft-deleting barang:', error);&#10;        res.status(500).json({&#10;            success: false,&#10;            message: 'Gagal menghapus barang: ' + error.message&#10;        });&#10;    }&#10;});&#10;&#10;// STEP 3: Update GET untuk tidak menampilkan barang yang sudah dihapus:&#10;app.get('/api/barang', async (req, res) =&gt; {&#10;    try {&#10;        const [rows] = await db.query(&#10;            'SELECT * FROM barang WHERE is_deleted = 0 OR is_deleted IS NULL'&#10;        );&#10;        res.json(rows);&#10;    } catch (error) {&#10;        res.status(500).json({ message: error.message });&#10;    }&#10;});&#10;&#10;&#10;// ============================================&#10;// OPSI 3: CASCADE DELETE (Hapus order_detail juga)&#10;// ============================================&#10;// PERINGATAN: Ini akan menghapus data order yang terkait!&#10;&#10;/*&#10;STEP 1: Ubah struktur tabel order_detail:&#10;&#10;ALTER TABLE order_detail &#10;DROP FOREIGN KEY order_detail_ibfk_2;  -- nama constraint mungkin berbeda&#10;&#10;ALTER TABLE order_detail &#10;ADD CONSTRAINT order_detail_barang_fk &#10;FOREIGN KEY (barang_id) REFERENCES barang(barang_id) ON DELETE CASCADE;&#10;&#10;Dengan ini, saat barang dihapus, order_detail yang terkait juga ikut terhapus.&#10;HATI-HATI: Data order akan hilang!&#10;*/&#10;&#10;&#10;// ============================================&#10;// OPSI 4: SET NULL pada order_detail&#10;// ============================================&#10;// Order tetap ada, tapi barang_id jadi NULL&#10;&#10;/*&#10;STEP 1: Ubah kolom barang_id menjadi nullable:&#10;&#10;ALTER TABLE order_detail MODIFY barang_id INT NULL;&#10;&#10;STEP 2: Ubah foreign key:&#10;&#10;ALTER TABLE order_detail &#10;DROP FOREIGN KEY order_detail_ibfk_2;&#10;&#10;ALTER TABLE order_detail &#10;ADD CONSTRAINT order_detail_barang_fk &#10;FOREIGN KEY (barang_id) REFERENCES barang(barang_id) ON DELETE SET NULL;&#10;&#10;Dengan ini, saat barang dihapus, barang_id di order_detail jadi NULL.&#10;*/&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>